<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dukshot - 截圖</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans TC", sans-serif;
        overflow: hidden;
        background: transparent;
        user-select: none;
      }

      /* 整體覆層 */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }

      /* 暗區域 - 使用四個獨立的 div */
      .dark-area {
        position: absolute;
        background: rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        cursor: crosshair !important; /* 確保暗區總是顯示十字游標 */
      }

      /* 選取區域容器 */
      .selection-box {
        position: absolute;
        border: 2px solid #0080ff;
        background: transparent;
        pointer-events: auto;
        z-index: 5;
        display: none;
      }

      .selection-box.active {
        display: block;
      }

      /* 選取區域內容區（用於拖曳） */
      .selection-content {
        position: absolute;
        width: 100%;
        height: 100%;
        background: transparent;
        cursor: move;
      }

      /* 調整大小控制點容器 */
      .resize-handles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      
      /* 單個控制點樣式 */
      .resize-handle {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid #0080ff;
        pointer-events: auto;
        z-index: 10;
      }

      /* 角控制點 */
      .resize-handle.top-left,
      .resize-handle.top-right,
      .resize-handle.bottom-left,
      .resize-handle.bottom-right {
        width: 12px;
        height: 12px;
      }

      .resize-handle.top-left {
        top: -6px;
        left: -6px;
        cursor: nw-resize;
      }

      .resize-handle.top-right {
        top: -6px;
        right: -6px;
        cursor: ne-resize;
      }

      .resize-handle.bottom-left {
        bottom: -6px;
        left: -6px;
        cursor: sw-resize;
      }

      .resize-handle.bottom-right {
        bottom: -6px;
        right: -6px;
        cursor: se-resize;
      }

      /* 邊控制點 */
      .resize-handle.top-center,
      .resize-handle.bottom-center {
        width: 12px;
        height: 12px;
        left: 50%;
        transform: translateX(-50%);
      }

      .resize-handle.top-center {
        top: -6px;
        cursor: n-resize;
      }

      .resize-handle.bottom-center {
        bottom: -6px;
        cursor: s-resize;
      }

      .resize-handle.middle-left,
      .resize-handle.middle-right {
        width: 12px;
        height: 12px;
        top: 50%;
        transform: translateY(-50%);
      }

      .resize-handle.middle-left {
        left: -6px;
        cursor: w-resize;
      }

      .resize-handle.middle-right {
        right: -6px;
        cursor: e-resize;
      }

      /* 選取資訊 */
      .selection-info {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-family: "Consolas", monospace;
        z-index: 1001;
        pointer-events: none;
      }

      /* 背景畫布 */
      #backgroundCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      /* 工具列 */
      .capture-toolbar {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 1002;
        display: none;
        gap: 8px;
        align-items: center;
        flex-direction: row;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .capture-btn {
        width: 68px;
        height: 64px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
        padding: 6px 4px;
        text-align: center;
      }

      .capture-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .capture-btn svg {
        transition: transform 0.2s ease;
        display: block;
      }

      .capture-btn .btn-text {
        font-size: 11px;
        line-height: 1;
        color: rgba(255,255,255,0.95);
        user-select: none;
        pointer-events: none;
      }

      .capture-btn:hover svg {
        transform: scale(1.1);
      }

      /* 幫助文字 */
      .help-text {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1003;
        text-align: center;
      }

      /* 尺寸顯示 */
      .dimension-display {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-family: "Consolas", monospace;
        z-index: 1005;
        pointer-events: none;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="help-text">拖曳選區｜Esc 取消｜右鍵重抓/取消｜Enter 儲存｜Ctrl+C 複製</div>

    <!-- 背景畫布 -->
    <canvas id="backgroundCanvas"></canvas>

    <!-- 覆層容器 -->
    <div class="overlay" id="overlay">
      <!-- 四個暗區 -->
      <div class="dark-area" data-area="top"></div>
      <div class="dark-area" data-area="bottom"></div>
      <div class="dark-area" data-area="left"></div>
      <div class="dark-area" data-area="right"></div>

      <!-- 選取區域 -->
      <div class="selection-box" id="selectionBox">
        <div class="selection-content"></div>
        <div class="resize-handles">
          <div class="resize-handle top-left"></div>
          <div class="resize-handle top-center"></div>
          <div class="resize-handle top-right"></div>
          <div class="resize-handle middle-left"></div>
          <div class="resize-handle middle-right"></div>
          <div class="resize-handle bottom-left"></div>
          <div class="resize-handle bottom-center"></div>
          <div class="resize-handle bottom-right"></div>
        </div>
      </div>
    </div>

    <!-- 尺寸顯示 -->
    <div class="dimension-display" id="dimensionDisplay" style="display: none;"></div>

    <!-- 工具列 -->
    <div class="capture-toolbar" id="captureToolbar">
      <button class="capture-btn" id="copyBtn" title="複製截圖 (Ctrl+C)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/>
        </svg>
        <div class="btn-text">複製到剪貼簿</div>
      </button>
      <button class="capture-btn" id="saveBtn" title="儲存截圖 (Enter)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
        </svg>
        <div class="btn-text">儲存</div>
      </button>
      <button class="capture-btn" id="cancelBtn" title="取消 (Esc)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
        </svg>
        <div class="btn-text">取消</div>
      </button>
    </div>

    <script>
      // 新的截圖系統架構
      class RegionCaptureSystem {
        constructor() {
          this.canvas = document.getElementById('backgroundCanvas');
          this.ctx = this.canvas.getContext('2d');
          this.overlay = document.getElementById('overlay');
          this.selectionBox = document.getElementById('selectionBox');
          this.dimensionDisplay = document.getElementById('dimensionDisplay');
          this.toolbar = document.getElementById('captureToolbar');
          
          // 選取狀態
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.selection = null;
          
          // 拖曳相關
          this.dragStartX = 0;
          this.dragStartY = 0;
          
          // 調整大小相關
          this.resizeHandle = null;
          this.resizeStartX = 0;
          this.resizeStartY = 0;
          this.resizeStartSelection = null;
          
          this.init();
        }

        async init() {
          // 設定畫布大小
          this.setupCanvas();
          
          // 設定事件監聽
          this.setupEventListeners();
          
          // 監聽螢幕數據
          this.listenForScreenData();
        }

        setupCanvas() {
          this.canvas.width = window.screen.width;
          this.canvas.height = window.screen.height;
          this.canvas.style.width = window.screen.width + 'px';
          this.canvas.style.height = window.screen.height + 'px';
        }

        listenForScreenData() {
          window.electronAPI.onScreenData((screenData) => {
            this.loadScreenImage(screenData);
          });
        }

        loadScreenImage(screenData) {
          const img = new Image();
          img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
            this.showInitialDarkOverlay();
          };
          img.src = screenData;
        }

        showInitialDarkOverlay() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.display = 'block';
          });
          
          // 設定初始全螢幕暗區
          this.updateDarkAreaPaths();
        }

        setupEventListeners() {
          // 暗區處理
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            // 確保暗區只有 crosshair 游標
            area.style.cursor = 'crosshair';
            
            area.addEventListener('mousedown', (e) => {
              if (e.target === area) {
                this.startNewSelection(e.clientX, e.clientY);
              }
            });
            
            // 防止暗區顯示調整大小的游標
            area.addEventListener('mousemove', (e) => {
              if (e.target === area) {
                area.style.cursor = 'crosshair';
              }
            });
          });

          // 選取區域內容拖曳
          const selectionContent = this.selectionBox.querySelector('.selection-content');
          selectionContent.style.cursor = 'move';  // 確保游標為 move
          
          selectionContent.addEventListener('mousedown', (e) => {
            if (e.target === selectionContent) {
              this.isDraggingSelection = true;
              this.dragStartX = e.clientX - this.selection.x;
              this.dragStartY = e.clientY - this.selection.y;
              e.stopPropagation();
            }
          });
          
          // 當滑鼠進入選取區域時確保顯示正確的游標
          selectionContent.addEventListener('mouseenter', () => {
            if (!this.isResizing && !this.isSelecting) {
              selectionContent.style.cursor = 'move';
            }
          });

          // 建立調整控制點
          const handles = [
            { class: 'top-left', cursor: 'nw-resize', pos: 'top: -6px; left: -6px; width: 12px; height: 12px;' },
            { class: 'top-center', cursor: 'n-resize', pos: 'top: -6px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px;' },
            { class: 'top-right', cursor: 'ne-resize', pos: 'top: -6px; right: -6px; width: 12px; height: 12px;' },
            { class: 'middle-left', cursor: 'w-resize', pos: 'top: 50%; left: -6px; transform: translateY(-50%); width: 12px; height: 12px;' },
            { class: 'middle-right', cursor: 'e-resize', pos: 'top: 50%; right: -6px; transform: translateY(-50%); width: 12px; height: 12px;' },
            { class: 'bottom-left', cursor: 'sw-resize', pos: 'bottom: -6px; left: -6px; width: 12px; height: 12px;' },
            { class: 'bottom-center', cursor: 's-resize', pos: 'bottom: -6px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px;' },
            { class: 'bottom-right', cursor: 'se-resize', pos: 'bottom: -6px; right: -6px; width: 12px; height: 12px;' }
          ];

          const resizeHandles = this.selectionBox.querySelector('.resize-handles');
          handles.forEach(handleInfo => {
            const handle = resizeHandles.querySelector(`.${handleInfo.class}`);
            if (handle) {
              // 設定游標
              handle.style.cursor = handleInfo.cursor;
              
              // 確保游標在懸停時顯示正確
              handle.addEventListener('mouseenter', () => {
                handle.style.cursor = handleInfo.cursor;
              });
              
              handle.addEventListener('mousedown', (e) => {
                this.isResizing = true;
                this.resizeHandle = handleInfo.class;
                this.resizeStartX = e.clientX;
                this.resizeStartY = e.clientY;
                this.resizeStartSelection = { ...this.selection };
                e.stopPropagation();
              });
            }
          });

          // 文檔級別的滑鼠事件
          document.addEventListener('mousemove', this.onMouseMove.bind(this));
          document.addEventListener('mouseup', this.onMouseUp.bind(this));
          
          // 鍵盤事件
          document.addEventListener('keydown', this.onKeyDown.bind(this));
          
          // 工具列按鈕
          document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());
          document.getElementById('saveBtn').addEventListener('click', () => this.saveScreenshot());
          document.getElementById('cancelBtn').addEventListener('click', () => window.close());
        }

        startNewSelection(x, y) {
          this.isSelecting = true;
          this.dragStartX = x;
          this.dragStartY = y;
          this.selection = { x, y, width: 0, height: 0 };
          
          // 隱藏工具列
          this.toolbar.style.display = 'none';
          document.querySelector('.help-text').style.display = 'none';
        }

        updateDarkAreaPaths() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.clipPath = '';
            // 確保暗區保持 crosshair 游標
            area.style.cursor = 'crosshair';
          });
          
          if (!this.selection) {
            // 全螢幕暗化
            darkAreas.forEach(area => {
              const areaType = area.dataset.area;
              switch (areaType) {
                case 'top':
                  area.style.cssText = 'top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair;';
                  break;
                case 'bottom':
                case 'left':
                case 'right':
                  area.style.cssText = 'display: none;';
                  break;
              }
            });
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          // 根據位置設定不同暗區
          darkAreas.forEach(area => {
            const areaType = area.dataset.area;
            area.style.display = 'block';
            area.style.cursor = 'crosshair'; // 強制設定游標
            
            switch (areaType) {
              case 'top':
                area.style.cssText = `top: 0; left: 0; width: 100%; height: ${y}px; cursor: crosshair;`;
                break;
              case 'bottom':
                area.style.cssText = `top: ${y + height}px; left: 0; width: 100%; bottom: 0; cursor: crosshair;`;
                break;
              case 'left':
                area.style.cssText = `top: ${y}px; left: 0; width: ${x}px; height: ${height}px; cursor: crosshair;`;
                break;
              case 'right':
                area.style.cssText = `top: ${y}px; left: ${x + width}px; right: 0; height: ${height}px; cursor: crosshair;`;
                break;
            }
          });
        }

        updateSelectionBox() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          this.selectionBox.style.left = x + 'px';
          this.selectionBox.style.top = y + 'px';
          this.selectionBox.style.width = width + 'px';
          this.selectionBox.style.height = height + 'px';
          this.selectionBox.classList.add('active');
          
          this.updateDarkAreaPaths();
        }

        updateDimensionDisplay() {
          if (!this.selection) {
            this.dimensionDisplay.style.display = 'none';
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          this.dimensionDisplay.textContent = `${width} × ${height}`;
          this.dimensionDisplay.style.display = 'block';
          
          // 位置在選區右上角
          let displayX = x + width + 10;
          let displayY = y;
          
          // 邊界檢查
          if (displayX + 100 > window.innerWidth) {
            displayX = x - 110;
          }
          if (displayY < 10) {
            displayY = 10;
          }
          
          this.dimensionDisplay.style.left = displayX + 'px';
          this.dimensionDisplay.style.top = displayY + 'px';
        }

        onMouseMove(e) {
          if (this.isDraggingSelection && this.selection) {
            // 拖曳選取區域時保持 move 游標
            document.body.style.cursor = 'move';
            
            this.selection.x = Math.max(0, Math.min(window.innerWidth - this.selection.width, e.clientX - this.dragStartX));
            this.selection.y = Math.max(0, Math.min(window.innerHeight - this.selection.height, e.clientY - this.dragStartY));
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          } else if (this.isResizing && this.selection && this.resizeStartSelection) {
            const dx = e.clientX - this.resizeStartX;
            const dy = e.clientY - this.resizeStartY;
            
            // 根據控制點調整選區
            this.adjustSelection(this.resizeHandle, dx, dy);
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          } else if (this.isSelecting) {
            const width = Math.abs(e.clientX - this.dragStartX);
            const height = Math.abs(e.clientY - this.dragStartY);
            const x = Math.min(e.clientX, this.dragStartX);
            const y = Math.min(e.clientY, this.dragStartY);
            
            this.selection = { x, y, width, height };
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          }
        }

        adjustSelection(handle, dx, dy) {
          const original = this.resizeStartSelection;
          let newX = original.x;
          let newY = original.y;
          let newWidth = original.width;
          let newHeight = original.height;
          
          switch (handle) {
            case 'top-left':
              newX = original.x + dx;
              newY = original.y + dy;
              newWidth = original.width - dx;
              newHeight = original.height - dy;
              break;
            case 'top-center':
              newY = original.y + dy;
              newHeight = original.height - dy;
              break;
            case 'top-right':
              newY = original.y + dy;
              newWidth = original.width + dx;
              newHeight = original.height - dy;
              break;
            case 'middle-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              break;
            case 'middle-right':
              newWidth = original.width + dx;
              break;
            case 'bottom-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              newHeight = original.height + dy;
              break;
            case 'bottom-center':
              newHeight = original.height + dy;
              break;
            case 'bottom-right':
              newWidth = original.width + dx;
              newHeight = original.height + dy;
              break;
          }
          
          // 確保最小尺寸
          if (newWidth < 10) newWidth = 10;
          if (newHeight < 10) newHeight = 10;
          
          // 邊界檢查
          if (newX < 0) {
            newWidth += newX;
            newX = 0;
          }
          if (newY < 0) {
            newHeight += newY;
            newY = 0;
          }
          if (newX + newWidth > window.innerWidth) {
            newWidth = window.innerWidth - newX;
          }
          if (newY + newHeight > window.innerHeight) {
            newHeight = window.innerHeight - newY;
          }
          
          this.selection = {
            x: Math.round(newX),
            y: Math.round(newY),
            width: Math.round(newWidth),
            height: Math.round(newHeight)
          };
        }

        onMouseUp(e) {
          if (this.isSelecting && this.selection) {
            // 確保選取區域有最小大小
            if (this.selection.width < 10 || this.selection.height < 10) {
              this.clearSelection();
            } else {
              this.showToolbar();
            }
          }
          
          // 重置游標
          if (this.isDraggingSelection || this.isResizing) {
            document.body.style.cursor = '';
          }
          
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.resizeHandle = null;
          this.resizeStartSelection = null;
        }

        onKeyDown(e) {
          if (e.key === 'Escape') {
            window.close();
          } else if (e.key === 'Enter' && this.selection) {
            this.saveScreenshot();
          } else if ((e.ctrlKey || e.metaKey) && e.key === 'c' && this.selection) {
            e.preventDefault();
            this.copyToClipboard();
          }
        }

        clearSelection() {
          this.selection = null;
          this.selectionBox.classList.remove('active');
          this.dimensionDisplay.style.display = 'none';
          this.toolbar.style.display = 'none';
          this.showInitialDarkOverlay();
        }

        showToolbar() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          // 計算工具列位置
          let left = x + width - 200;
          let top = y + height + 10;
          
          // 邊界檢查
          if (left < 10) left = 10;
          if (left + 200 > window.innerWidth) left = window.innerWidth - 210;
          if (top + 80 > window.innerHeight) top = y - 90;
          
          this.toolbar.style.left = left + 'px';
          this.toolbar.style.top = top + 'px';
          this.toolbar.style.display = 'flex';
        }

        async copyToClipboard() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = this.selection.width;
            tempCanvas.height = this.selection.height;
            
            tempCtx.drawImage(
              this.canvas,
              this.selection.x,
              this.selection.y,
              this.selection.width,
              this.selection.height,
              0,
              0,
              this.selection.width,
              this.selection.height
            );
            
            tempCanvas.toBlob(async (blob) => {
              await navigator.clipboard.write([
                new ClipboardItem({ [blob.type]: blob })
              ]);
              window.close();
            });
          } catch (error) {
            console.error('複製到剪貼簿失敗:', error);
          }
        }

        async saveScreenshot() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = this.selection.width;
            tempCanvas.height = this.selection.height;
            
            tempCtx.drawImage(
              this.canvas,
              this.selection.x,
              this.selection.y,
              this.selection.width,
              this.selection.height,
              0,
              0,
              this.selection.width,
              this.selection.height
            );
            
            const imageData = tempCanvas.toDataURL('image/png');
            const result = await window.electronAPI.saveScreenshot(imageData, 'png');
            
            if (result.success) {
              window.close();
            }
          } catch (error) {
            console.error('儲存截圖失敗:', error);
          }
        }
      }

      // 初始化
      document.addEventListener('DOMContentLoaded', () => {
        new RegionCaptureSystem();
      });
    </script>
  </body>
</html>