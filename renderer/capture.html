<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dukshot - æˆªåœ–</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans TC", sans-serif;
        overflow: hidden;
        background: transparent;
        user-select: none;
      }

      /* æ•´é«”è¦†å±¤ */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }

      /* æš—å€åŸŸ - ä½¿ç”¨å››å€‹ç¨ç«‹çš„ div */
      .dark-area {
        position: absolute;
        background: rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        cursor: crosshair !important; /* ç¢ºä¿æš—å€ç¸½æ˜¯é¡¯ç¤ºåå­—æ¸¸æ¨™ */
      }

      /* é¸å–å€åŸŸå®¹å™¨ */
      .selection-box {
        position: absolute;
        border: 2px solid #0080ff;
        background: transparent;
        pointer-events: auto;
        z-index: 5;
        display: none;
      }

      .selection-box.active {
        display: block;
      }

      /* é¸å–å€åŸŸå…§å®¹å€ï¼ˆç”¨æ–¼æ‹–æ›³ï¼‰ */
      .selection-content {
        position: absolute;
        width: 100%;
        height: 100%;
        background: transparent;
        cursor: move;
      }

      /* èª¿æ•´å¤§å°æ§åˆ¶é»å®¹å™¨ */
      .resize-handles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      
      /* å–®å€‹æ§åˆ¶é»æ¨£å¼ */
      .resize-handle {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid #0080ff;
        pointer-events: auto;
        z-index: 10;
      }

      /* è§’æ§åˆ¶é» */
      .resize-handle.top-left,
      .resize-handle.top-right,
      .resize-handle.bottom-left,
      .resize-handle.bottom-right {
        width: 12px;
        height: 12px;
      }

      .resize-handle.top-left {
        top: -6px;
        left: -6px;
        cursor: nw-resize;
      }

      .resize-handle.top-right {
        top: -6px;
        right: -6px;
        cursor: ne-resize;
      }

      .resize-handle.bottom-left {
        bottom: -6px;
        left: -6px;
        cursor: sw-resize;
      }

      .resize-handle.bottom-right {
        bottom: -6px;
        right: -6px;
        cursor: se-resize;
      }

      /* é‚Šæ§åˆ¶é» */
      .resize-handle.top-center,
      .resize-handle.bottom-center {
        width: 12px;
        height: 12px;
        left: 50%;
        transform: translateX(-50%);
      }

      .resize-handle.top-center {
        top: -6px;
        cursor: n-resize;
      }

      .resize-handle.bottom-center {
        bottom: -6px;
        cursor: s-resize;
      }

      .resize-handle.middle-left,
      .resize-handle.middle-right {
        width: 12px;
        height: 12px;
        top: 50%;
        transform: translateY(-50%);
      }

      .resize-handle.middle-left {
        left: -6px;
        cursor: w-resize;
      }

      .resize-handle.middle-right {
        right: -6px;
        cursor: e-resize;
      }

      /* é¸å–è³‡è¨Š */
      .selection-info {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-family: "Consolas", monospace;
        z-index: 1001;
        pointer-events: none;
      }

      /* èƒŒæ™¯ç•«å¸ƒ */
      #backgroundCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
      }

      /* å·¥å…·åˆ— */
      .capture-toolbar {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 1002;
        display: none;
        gap: 8px;
        align-items: center;
        flex-direction: row;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .capture-btn {
        width: 68px;
        height: 64px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
        padding: 6px 4px;
        text-align: center;
      }

      .capture-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .capture-btn svg {
        transition: transform 0.2s ease;
        display: block;
      }

      .capture-btn .btn-text {
        font-size: 11px;
        line-height: 1;
        color: rgba(255,255,255,0.95);
        user-select: none;
        pointer-events: none;
      }

      .capture-btn:hover svg {
        transform: scale(1.1);
      }

      /* å¹«åŠ©æ–‡å­— */
      .help-text {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1003;
        text-align: center;
      }

      /* å°ºå¯¸é¡¯ç¤º */
      .dimension-display {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-family: "Consolas", monospace;
        z-index: 1005;
        pointer-events: none;
        white-space: nowrap;
      }

      /* DPI è¨ºæ–·é¡¯ç¤º */
      .dpi-info {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: #0ff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-family: "Consolas", monospace;
        z-index: 1006;
        pointer-events: none;
        opacity: 0.8;
      }

      /* ä¸Šå‚³å½ˆçª— */
      .upload-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .upload-modal.show {
        display: flex;
        opacity: 1;
      }

      .upload-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .upload-modal.show .upload-content {
        transform: scale(1);
      }

      .upload-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #333;
      }

      /* è¼‰å…¥å‹•ç•« */
      .upload-loading {
        text-align: center;
        padding: 20px 0;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0080ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* æˆåŠŸç‹€æ…‹ */
      .upload-success {
        color: #28a745;
      }

      .upload-preview {
        margin: 16px 0;
        text-align: center;
      }

      .upload-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .upload-links {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
      }

      .link-row {
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .link-label {
        font-weight: 600;
        font-size: 13px;
        color: #666;
        min-width: 80px;
      }

      .link-value {
        flex: 1;
        font-size: 12px;
        background: white;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        word-break: break-all;
        cursor: pointer;
      }

      .link-value:hover {
        background: #f0f0f0;
      }

      .copy-btn-small {
        padding: 4px 8px;
        background: #0080ff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
      }

      .copy-btn-small:hover {
        background: #0066cc;
      }

      /* éŒ¯èª¤ç‹€æ…‹ */
      .upload-error {
        color: #dc3545;
        text-align: center;
        padding: 20px 0;
      }

      .error-message {
        margin: 16px 0;
        padding: 12px;
        background: #fee;
        border-radius: 8px;
        color: #c00;
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: #0080ff;
        color: white;
      }

      .modal-btn-primary:hover {
        background: #0066cc;
      }

      .modal-btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .modal-btn-secondary:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="help-text">æ‹–æ›³é¸å€ï½œEsc å–æ¶ˆï½œå³éµé‡æŠ“/å–æ¶ˆï½œEnter å„²å­˜ï½œCtrl+C è¤‡è£½</div>

    <!-- èƒŒæ™¯ç•«å¸ƒ -->
    <canvas id="backgroundCanvas"></canvas>

    <!-- è¦†å±¤å®¹å™¨ -->
    <div class="overlay" id="overlay">
      <!-- å››å€‹æš—å€ -->
      <div class="dark-area" data-area="top"></div>
      <div class="dark-area" data-area="bottom"></div>
      <div class="dark-area" data-area="left"></div>
      <div class="dark-area" data-area="right"></div>

      <!-- é¸å–å€åŸŸ -->
      <div class="selection-box" id="selectionBox">
        <div class="selection-content"></div>
        <div class="resize-handles">
          <div class="resize-handle top-left"></div>
          <div class="resize-handle top-center"></div>
          <div class="resize-handle top-right"></div>
          <div class="resize-handle middle-left"></div>
          <div class="resize-handle middle-right"></div>
          <div class="resize-handle bottom-left"></div>
          <div class="resize-handle bottom-center"></div>
          <div class="resize-handle bottom-right"></div>
        </div>
      </div>
    </div>

    <!-- å°ºå¯¸é¡¯ç¤º -->
    <div class="dimension-display" id="dimensionDisplay" style="display: none;"></div>

    <!-- DPI è¨ºæ–·è³‡è¨Š -->
    <div class="dpi-info" id="dpiInfo"></div>

    <!-- ä¸Šå‚³å½ˆçª— -->
    <div class="upload-modal" id="uploadModal">
      <div class="upload-content">
        <div id="uploadModalContent">
          <!-- å‹•æ…‹å…§å®¹ -->
        </div>
      </div>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div class="capture-toolbar" id="captureToolbar">
      <button class="capture-btn" id="copyBtn" title="è¤‡è£½æˆªåœ– (Ctrl+C)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/>
        </svg>
        <div class="btn-text">è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>
      </button>
      <button class="capture-btn" id="saveBtn" title="å„²å­˜æˆªåœ– (Enter)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
        </svg>
        <div class="btn-text">å„²å­˜</div>
      </button>
      <button class="capture-btn" id="uploadBtn" title="ä¸Šå‚³åœ–ç‰‡">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" fill="currentColor"/>
        </svg>
        <div class="btn-text">ä¸Šå‚³</div>
      </button>
      <button class="capture-btn" id="cancelBtn" title="å–æ¶ˆ (Esc)">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
        </svg>
        <div class="btn-text">å–æ¶ˆ</div>
      </button>
    </div>

    <script>
      // é«˜ DPI è¢å¹•æˆªåœ–ç³»çµ±
      class HighDPICaptureSystem {
        constructor() {
          this.canvas = document.getElementById('backgroundCanvas');
          this.ctx = this.canvas.getContext('2d');
          this.overlay = document.getElementById('overlay');
          this.selectionBox = document.getElementById('selectionBox');
          this.dimensionDisplay = document.getElementById('dimensionDisplay');
          this.toolbar = document.getElementById('captureToolbar');
          this.dpiInfo = document.getElementById('dpiInfo');
          this.uploadModal = document.getElementById('uploadModal');
          
          // DPI ç›¸é—œ
          this.dpr = window.devicePixelRatio || 1;
          
          // é¸å–ç‹€æ…‹
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.selection = null;
          
          // æ‹–æ›³ç›¸é—œ
          this.dragStartX = 0;
          this.dragStartY = 0;
          
          // èª¿æ•´å¤§å°ç›¸é—œ
          this.resizeHandle = null;
          this.resizeStartX = 0;
          this.resizeStartY = 0;
          this.resizeStartSelection = null;
          
          // ä¸Šå‚³ API è¨­å®š
          this.API_URL = "https://api.urusai.cc/v1/upload";
          this.TOKEN = "5b857ee4fcaff92c51cd2ddfd1578b95670a5ddca0cd9831b5791640b42ad4215b857ee4fcaff92c51cd2ddfd1578b95670a5ddca0cd9831b5791640b42ad421";
          
          // åˆå§‹åŒ–
          this.init();
        }

        async init() {
          console.log('=== DPI è¨ºæ–· ===');
          console.log('Device Pixel Ratio:', this.dpr);
          console.log('è¢å¹•å°ºå¯¸:', window.screen.width, 'x', window.screen.height);
          
          // é¡¯ç¤º DPI è³‡è¨Š
          this.showDPIInfo();
          
          // è¨­å®šé«˜è§£æåº¦ç•«å¸ƒ
          this.setupHighDPICanvas();
          
          // è¨­å®šäº‹ä»¶ç›£è½
          this.setupEventListeners();
          
          // ç›£è½è¢å¹•æ•¸æ“š
          this.listenForScreenData();
        }

        showDPIInfo() {
          if (this.dpiInfo) {
            this.dpiInfo.textContent = `DPR: ${this.dpr} | ${window.screen.width}Ã—${window.screen.height}`;
            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
              this.dpiInfo.style.display = 'none';
            }, 3000);
          }
        }

        setupHighDPICanvas() {
          const screenWidth = window.screen.width;
          const screenHeight = window.screen.height;
          
          // è¨­å®šå¯¦éš›è§£æåº¦ï¼ˆè€ƒæ…® DPIï¼‰
          this.canvas.width = screenWidth * this.dpr;
          this.canvas.height = screenHeight * this.dpr;
          
          // è¨­å®š CSS é¡¯ç¤ºå°ºå¯¸
          this.canvas.style.width = screenWidth + 'px';
          this.canvas.style.height = screenHeight + 'px';
          
          console.log('Canvas å¯¦éš›å°ºå¯¸:', this.canvas.width, 'x', this.canvas.height);
          console.log('Canvas CSS å°ºå¯¸:', this.canvas.style.width, 'x', this.canvas.style.height);
          
          // è¨­å®šé«˜å“è³ªæ¸²æŸ“ - å„ªåŒ–ç•«è³ªè¨­å®š
          this.ctx.imageSmoothingEnabled = false;
          this.ctx.imageSmoothingQuality = 'high';
          
          // é¡å¤–çš„ç•«è³ªå„ªåŒ–è¨­å®š
          this.ctx.mozImageSmoothingEnabled = false;
          this.ctx.webkitImageSmoothingEnabled = false;
          this.ctx.msImageSmoothingEnabled = false;
        }

        listenForScreenData() {
          window.electronAPI.onScreenData((screenData) => {
            console.log('æ¥æ”¶åˆ°è¢å¹•æ•¸æ“š');
            this.loadHighResScreenImage(screenData);
          });
        }

        loadHighResScreenImage(screenData) {
          const img = new Image();
          
          img.onload = () => {
            console.log('åœ–ç‰‡è¼‰å…¥å®Œæˆ');
            console.log('åœ–ç‰‡åŸå§‹å°ºå¯¸:', img.naturalWidth, 'x', img.naturalHeight);
            
            // æ¸…é™¤ canvas
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            // ä¿å­˜ç•¶å‰ç‹€æ…‹
            this.ctx.save();
            
            // é‡ç½®è®Šæ›çŸ©é™£
            this.ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            // é—œé–‰åœ–ç‰‡å¹³æ»‘ä»¥ä¿æŒéŠ³åˆ©åº¦ - åŠ å¼·ç•«è³ª
            this.ctx.imageSmoothingEnabled = false;
            this.ctx.mozImageSmoothingEnabled = false;
            this.ctx.webkitImageSmoothingEnabled = false;
            this.ctx.msImageSmoothingEnabled = false;
            
            // åˆ¤æ–·åœ–ç‰‡å’Œ canvas çš„æ¯”ä¾‹
            const scaleX = this.canvas.width / img.naturalWidth;
            const scaleY = this.canvas.height / img.naturalHeight;
            
            console.log('ç¸®æ”¾æ¯”ä¾‹:', scaleX, 'x', scaleY);
            
            // å¦‚æœæ˜¯ 1:1 æˆ–æ¥è¿‘ï¼Œç›´æ¥ç¹ªè£½
            if (Math.abs(scaleX - 1) < 0.01 && Math.abs(scaleY - 1) < 0.01) {
              console.log('1:1 ç¹ªè£½ï¼ˆç„¡ç¸®æ”¾ï¼‰');
              this.ctx.drawImage(img, 0, 0);
            } else {
              console.log('ç¸®æ”¾ç¹ªè£½');
              // ç¹ªè£½å®Œæ•´è§£æåº¦åœ–ç‰‡
              this.ctx.drawImage(
                img,
                0, 0, img.naturalWidth, img.naturalHeight,
                0, 0, this.canvas.width, this.canvas.height
              );
            }
            
            // æ¢å¾©ç‹€æ…‹
            this.ctx.restore();
            
            // é¡¯ç¤ºåˆå§‹æš—è¦†å±¤
            this.showInitialDarkOverlay();
          };
          
          img.onerror = (error) => {
            console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', error);
          };
          
          img.src = screenData;
        }

        showInitialDarkOverlay() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.display = 'block';
          });
          
          // è¨­å®šåˆå§‹å…¨è¢å¹•æš—å€
          this.updateDarkAreaPaths();
        }

        setupEventListeners() {
          // æš—å€è™•ç†
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            // ç¢ºä¿æš—å€åªæœ‰ crosshair æ¸¸æ¨™
            area.style.cursor = 'crosshair';
            
            area.addEventListener('mousedown', (e) => {
              if (e.target === area) {
                this.startNewSelection(e.clientX, e.clientY);
              }
            });
            
            // é˜²æ­¢æš—å€é¡¯ç¤ºèª¿æ•´å¤§å°çš„æ¸¸æ¨™
            area.addEventListener('mousemove', (e) => {
              if (e.target === area) {
                area.style.cursor = 'crosshair';
              }
            });
          });

          // é¸å–å€åŸŸå…§å®¹æ‹–æ›³
          const selectionContent = this.selectionBox.querySelector('.selection-content');
          selectionContent.style.cursor = 'move';  // ç¢ºä¿æ¸¸æ¨™ç‚º move
          
          selectionContent.addEventListener('mousedown', (e) => {
            if (e.target === selectionContent) {
              this.isDraggingSelection = true;
              this.dragStartX = e.clientX - this.selection.x;
              this.dragStartY = e.clientY - this.selection.y;
              e.stopPropagation();
            }
          });
          
          // ç•¶æ»‘é¼ é€²å…¥é¸å–å€åŸŸæ™‚ç¢ºä¿é¡¯ç¤ºæ­£ç¢ºçš„æ¸¸æ¨™
          selectionContent.addEventListener('mouseenter', () => {
            if (!this.isResizing && !this.isSelecting) {
              selectionContent.style.cursor = 'move';
            }
          });

          // å»ºç«‹èª¿æ•´æ§åˆ¶é»
          const handles = [
            { class: 'top-left', cursor: 'nw-resize' },
            { class: 'top-center', cursor: 'n-resize' },
            { class: 'top-right', cursor: 'ne-resize' },
            { class: 'middle-left', cursor: 'w-resize' },
            { class: 'middle-right', cursor: 'e-resize' },
            { class: 'bottom-left', cursor: 'sw-resize' },
            { class: 'bottom-center', cursor: 's-resize' },
            { class: 'bottom-right', cursor: 'se-resize' }
          ];

          const resizeHandles = this.selectionBox.querySelector('.resize-handles');
          handles.forEach(handleInfo => {
            const handle = resizeHandles.querySelector(`.${handleInfo.class}`);
            if (handle) {
              // è¨­å®šæ¸¸æ¨™
              handle.style.cursor = handleInfo.cursor;
              
              // ç¢ºä¿æ¸¸æ¨™åœ¨æ‡¸åœæ™‚é¡¯ç¤ºæ­£ç¢º
              handle.addEventListener('mouseenter', () => {
                handle.style.cursor = handleInfo.cursor;
              });
              
              handle.addEventListener('mousedown', (e) => {
                this.isResizing = true;
                this.resizeHandle = handleInfo.class;
                this.resizeStartX = e.clientX;
                this.resizeStartY = e.clientY;
                this.resizeStartSelection = { ...this.selection };
                e.stopPropagation();
              });
            }
          });

          // æ–‡æª”ç´šåˆ¥çš„æ»‘é¼ äº‹ä»¶
          document.addEventListener('mousemove', this.onMouseMove.bind(this));
          document.addEventListener('mouseup', this.onMouseUp.bind(this));
          
          // éµç›¤äº‹ä»¶
          document.addEventListener('keydown', this.onKeyDown.bind(this));
          
          // å·¥å…·åˆ—æŒ‰éˆ•
          document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());
          document.getElementById('saveBtn').addEventListener('click', () => this.saveScreenshot());
          document.getElementById('uploadBtn').addEventListener('click', () => this.uploadScreenshot());
          document.getElementById('cancelBtn').addEventListener('click', () => window.close());
        }

        startNewSelection(x, y) {
          this.isSelecting = true;
          this.dragStartX = x;
          this.dragStartY = y;
          this.selection = { x, y, width: 0, height: 0 };
          
          // éš±è—å·¥å…·åˆ—
          this.toolbar.style.display = 'none';
          document.querySelector('.help-text').style.display = 'none';
        }

        updateDarkAreaPaths() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.clipPath = '';
            // ç¢ºä¿æš—å€ä¿æŒ crosshair æ¸¸æ¨™
            area.style.cursor = 'crosshair';
          });
          
          if (!this.selection) {
            // å…¨è¢å¹•æš—åŒ–
            darkAreas.forEach(area => {
              const areaType = area.dataset.area;
              switch (areaType) {
                case 'top':
                  area.style.cssText = 'top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair;';
                  break;
                case 'bottom':
                case 'left':
                case 'right':
                  area.style.cssText = 'display: none;';
                  break;
              }
            });
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          // æ ¹æ“šä½ç½®è¨­å®šä¸åŒæš—å€
          darkAreas.forEach(area => {
            const areaType = area.dataset.area;
            area.style.display = 'block';
            area.style.cursor = 'crosshair'; // å¼·åˆ¶è¨­å®šæ¸¸æ¨™
            
            switch (areaType) {
              case 'top':
                area.style.cssText = `top: 0; left: 0; width: 100%; height: ${y}px; cursor: crosshair;`;
                break;
              case 'bottom':
                area.style.cssText = `top: ${y + height}px; left: 0; width: 100%; bottom: 0; cursor: crosshair;`;
                break;
              case 'left':
                area.style.cssText = `top: ${y}px; left: 0; width: ${x}px; height: ${height}px; cursor: crosshair;`;
                break;
              case 'right':
                area.style.cssText = `top: ${y}px; left: ${x + width}px; right: 0; height: ${height}px; cursor: crosshair;`;
                break;
            }
          });
        }

        updateSelectionBox() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          this.selectionBox.style.left = x + 'px';
          this.selectionBox.style.top = y + 'px';
          this.selectionBox.style.width = width + 'px';
          this.selectionBox.style.height = height + 'px';
          this.selectionBox.classList.add('active');
          
          this.updateDarkAreaPaths();
        }

        updateDimensionDisplay() {
          if (!this.selection) {
            this.dimensionDisplay.style.display = 'none';
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          // é¡¯ç¤ºå¯¦éš›åƒç´ å°ºå¯¸ï¼ˆè€ƒæ…® DPIï¼‰
          const actualWidth = Math.round(width * this.dpr);
          const actualHeight = Math.round(height * this.dpr);
          
          this.dimensionDisplay.textContent = `${actualWidth} Ã— ${actualHeight} px`;
          this.dimensionDisplay.style.display = 'block';
          
          // ä½ç½®åœ¨é¸å€å³ä¸Šè§’
          let displayX = x + width + 10;
          let displayY = y;
          
          // é‚Šç•Œæª¢æŸ¥
          if (displayX + 150 > window.innerWidth) {
            displayX = x - 160;
          }
          if (displayY < 10) {
            displayY = 10;
          }
          
          this.dimensionDisplay.style.left = displayX + 'px';
          this.dimensionDisplay.style.top = displayY + 'px';
        }

        onMouseMove(e) {
          if (this.isDraggingSelection && this.selection) {
            // æ‹–æ›³é¸å–å€åŸŸæ™‚ä¿æŒ move æ¸¸æ¨™
            document.body.style.cursor = 'move';
            
            // ç§»å‹•æ™‚éš±è—å·¥å…·åˆ—é¿å…æ“‹ä½è¦–ç·š
            this.toolbar.style.display = 'none';
            
            this.selection.x = Math.max(0, Math.min(window.innerWidth - this.selection.width, e.clientX - this.dragStartX));
            this.selection.y = Math.max(0, Math.min(window.innerHeight - this.selection.height, e.clientY - this.dragStartY));
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          } else if (this.isResizing && this.selection && this.resizeStartSelection) {
            const dx = e.clientX - this.resizeStartX;
            const dy = e.clientY - this.resizeStartY;
            
            // èª¿æ•´å¤§å°æ™‚éš±è—å·¥å…·åˆ—
            this.toolbar.style.display = 'none';
            
            // æ ¹æ“šæ§åˆ¶é»èª¿æ•´é¸å€
            this.adjustSelection(this.resizeHandle, dx, dy);
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          } else if (this.isSelecting) {
            const width = Math.abs(e.clientX - this.dragStartX);
            const height = Math.abs(e.clientY - this.dragStartY);
            const x = Math.min(e.clientX, this.dragStartX);
            const y = Math.min(e.clientY, this.dragStartY);
            
            this.selection = { x, y, width, height };
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          }
        }

        adjustSelection(handle, dx, dy) {
          const original = this.resizeStartSelection;
          let newX = original.x;
          let newY = original.y;
          let newWidth = original.width;
          let newHeight = original.height;
          
          switch (handle) {
            case 'top-left':
              newX = original.x + dx;
              newY = original.y + dy;
              newWidth = original.width - dx;
              newHeight = original.height - dy;
              break;
            case 'top-center':
              newY = original.y + dy;
              newHeight = original.height - dy;
              break;
            case 'top-right':
              newY = original.y + dy;
              newWidth = original.width + dx;
              newHeight = original.height - dy;
              break;
            case 'middle-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              break;
            case 'middle-right':
              newWidth = original.width + dx;
              break;
            case 'bottom-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              newHeight = original.height + dy;
              break;
            case 'bottom-center':
              newHeight = original.height + dy;
              break;
            case 'bottom-right':
              newWidth = original.width + dx;
              newHeight = original.height + dy;
              break;
          }
          
          // ç¢ºä¿æœ€å°å°ºå¯¸
          if (newWidth < 10) newWidth = 10;
          if (newHeight < 10) newHeight = 10;
          
          // é‚Šç•Œæª¢æŸ¥
          if (newX < 0) {
            newWidth += newX;
            newX = 0;
          }
          if (newY < 0) {
            newHeight += newY;
            newY = 0;
          }
          if (newX + newWidth > window.innerWidth) {
            newWidth = window.innerWidth - newX;
          }
          if (newY + newHeight > window.innerHeight) {
            newHeight = window.innerHeight - newY;
          }
          
          this.selection = {
            x: Math.round(newX),
            y: Math.round(newY),
            width: Math.round(newWidth),
            height: Math.round(newHeight)
          };
        }

        onMouseUp(e) {
          if (this.isSelecting && this.selection) {
            // ç¢ºä¿é¸å–å€åŸŸæœ‰æœ€å°å¤§å°
            if (this.selection.width < 10 || this.selection.height < 10) {
              this.clearSelection();
            } else {
              this.showToolbar();
            }
          }
          
          // æ‹–æ›³æˆ–èª¿æ•´å¤§å°çµæŸå¾Œï¼Œé‡æ–°é¡¯ç¤ºå·¥å…·åˆ—
          if ((this.isDraggingSelection || this.isResizing) && this.selection) {
            this.showToolbar();
          }
          
          // é‡ç½®æ¸¸æ¨™
          if (this.isDraggingSelection || this.isResizing) {
            document.body.style.cursor = '';
          }
          
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.resizeHandle = null;
          this.resizeStartSelection = null;
        }

        onKeyDown(e) {
          if (e.key === 'Escape') {
            window.close();
          } else if (e.key === 'Enter' && this.selection) {
            this.saveScreenshot();
          } else if ((e.ctrlKey || e.metaKey) && e.key === 'c' && this.selection) {
            e.preventDefault();
            this.copyToClipboard();
          }
        }

        clearSelection() {
          this.selection = null;
          this.selectionBox.classList.remove('active');
          this.dimensionDisplay.style.display = 'none';
          this.toolbar.style.display = 'none';
          this.showInitialDarkOverlay();
        }

        showToolbar() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          // è¨ˆç®—å·¥å…·åˆ—ä½ç½®
          let left = x + width - 280; // èª¿æ•´ç‚º 4 å€‹æŒ‰éˆ•çš„å¯¬åº¦
          let top = y + height + 10;
          
          // é‚Šç•Œæª¢æŸ¥
          if (left < 10) left = 10;
          if (left + 280 > window.innerWidth) left = window.innerWidth - 290;
          if (top + 80 > window.innerHeight) top = y - 90;
          
          this.toolbar.style.left = left + 'px';
          this.toolbar.style.top = top + 'px';
          this.toolbar.style.display = 'flex';
        }

        updateToolbarPosition() {
          if (!this.selection || this.toolbar.style.display === 'none') return;
          
          const { x, y, width, height } = this.selection;
          
          // è¨ˆç®—å·¥å…·åˆ—ä½ç½®
          let left = x + width - 280; // èª¿æ•´ç‚º 4 å€‹æŒ‰éˆ•çš„å¯¬åº¦
          let top = y + height + 10;
          
          // é‚Šç•Œæª¢æŸ¥
          if (left < 10) left = 10;
          if (left + 280 > window.innerWidth) left = window.innerWidth - 290;
          if (top + 80 > window.innerHeight) top = y - 90;
          
          this.toolbar.style.left = left + 'px';
          this.toolbar.style.top = top + 'px';
        }

        async copyToClipboard() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // è¨­å®šé«˜è§£æåº¦å°ºå¯¸
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            // é—œé–‰åœ–ç‰‡å¹³æ»‘ - ä¿æŒæœ€é«˜å“è³ª
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            tempCtx.imageSmoothingQuality = 'high';
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            tempCtx.imageSmoothingQuality = 'high';
            
            // å¾é«˜è§£æåº¦ canvas æ“·å–
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            tempCanvas.toBlob(async (blob) => {
              await navigator.clipboard.write([
                new ClipboardItem({ [blob.type]: blob })
              ]);
              window.close();
            });
          } catch (error) {
            console.error('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—:', error);
          }
        }

        async saveScreenshot() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // è¨­å®šé«˜è§£æåº¦å°ºå¯¸
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            console.log('å„²å­˜æˆªåœ– - Canvas å°ºå¯¸:', tempCanvas.width, 'x', tempCanvas.height);
            
            // é—œé–‰åœ–ç‰‡å¹³æ»‘ä»¥ä¿æŒéŠ³åˆ©åº¦ - æœ€é«˜å“è³ªè¨­å®š
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            tempCtx.imageSmoothingQuality = 'high';
            
            // å¾é«˜è§£æåº¦ canvas æ“·å–æ­£ç¢ºçš„å€åŸŸ
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            // è½‰æ›ç‚ºé«˜å“è³ª PNG
            const imageData = tempCanvas.toDataURL('image/png', 1.0);
            const result = await window.electronAPI.saveScreenshot(imageData, 'png');
            
            if (result.success) {
              console.log('æˆªåœ–å„²å­˜æˆåŠŸ');
              window.close();
            } else {
              console.error('æˆªåœ–å„²å­˜å¤±æ•—:', result.error);
            }
          } catch (error) {
            console.error('å„²å­˜æˆªåœ–å¤±æ•—:', error);
          }
        }

        async uploadScreenshot() {
          if (!this.selection) return;
          
          try {
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            this.showUploadModal('loading');
            
            // å‰µå»ºè‡¨æ™‚ canvas ç²å–é¸å–å€åŸŸ
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            tempCtx.imageSmoothingEnabled = false;
            
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            // è½‰æ›ç‚º Blob
            const blob = await new Promise(resolve => {
              tempCanvas.toBlob(resolve, 'image/png', 1.0);
            });
            
            // å‰µå»º FormData
            const formData = new FormData();
            formData.append('file', blob, 'screenshot.png');
            formData.append('token', this.TOKEN);
            formData.append('r18', '0');
            
            // ç™¼é€è«‹æ±‚
            const response = await fetch(this.API_URL, {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
              this.showUploadModal('success', data.data);
              // è‡ªå‹•è¤‡è£½ç›´é€£åˆ°å‰ªè²¼ç°¿
              if (data.data.url_direct) {
                navigator.clipboard.writeText(data.data.url_direct);
              }
            } else {
              this.showUploadModal('error', data.message || 'ä¸Šå‚³å¤±æ•—');
            }
          } catch (error) {
            console.error('ä¸Šå‚³æˆªåœ–å¤±æ•—:', error);
            this.showUploadModal('error', error.message || 'ç¶²è·¯éŒ¯èª¤');
          }
        }

        showUploadModal(state, data = null) {
          const modal = this.uploadModal;
          const content = document.getElementById('uploadModalContent');
          
          switch (state) {
            case 'loading':
              content.innerHTML = `
                <div class="upload-title">æ­£åœ¨ä¸Šå‚³...</div>
                <div class="upload-loading">
                  <div class="spinner"></div>
                  <div>è«‹ç¨å€™ï¼Œæ­£åœ¨ä¸Šå‚³æˆªåœ–åˆ°ä¼ºæœå™¨</div>
                </div>
              `;
              break;
              
            case 'success':
              content.innerHTML = `
                <div class="upload-title upload-success">âœ“ ä¸Šå‚³æˆåŠŸï¼</div>
                ${data.url_preview ? `
                <div class="upload-preview">
                  <img src="${data.url_preview}" alt="é è¦½åœ–" />
                </div>
                ` : ''}
                <div class="upload-links">
                  <div class="link-row">
                    <span class="link-label">é è¦½é€£çµï¼š</span>
                    <div class="link-value" onclick="navigator.clipboard.writeText('${data.url_preview}')">${data.url_preview}</div>
                    <button class="copy-btn-small" onclick="navigator.clipboard.writeText('${data.url_preview}')">è¤‡è£½</button>
                  </div>
                  <div class="link-row">
                    <span class="link-label">ç›´é€£é€£çµï¼š</span>
                    <div class="link-value" onclick="navigator.clipboard.writeText('${data.url_direct}')">${data.url_direct}</div>
                    <button class="copy-btn-small" onclick="navigator.clipboard.writeText('${data.url_direct}')">è¤‡è£½</button>
                  </div>
                  <div class="link-row">
                    <span class="link-label">åˆªé™¤é€£çµï¼š</span>
                    <div class="link-value" onclick="navigator.clipboard.writeText('${data.url_delete}')">${data.url_delete}</div>
                    <button class="copy-btn-small" onclick="navigator.clipboard.writeText('${data.url_delete}')">è¤‡è£½</button>
                  </div>
                </div>
                <div style="color: #28a745; text-align: center; margin-top: 12px;">
                  ğŸ’¡ ç›´é€£é€£çµå·²è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿
                </div>
                <div class="modal-buttons">
                  <button class="modal-btn modal-btn-primary" onclick="window.close()">å®Œæˆ</button>
                  <button class="modal-btn modal-btn-secondary" onclick="document.getElementById('uploadModal').classList.remove('show')">ç¹¼çºŒç·¨è¼¯</button>
                </div>
              `;
              break;
              
            case 'error':
              content.innerHTML = `
                <div class="upload-title upload-error">âœ— ä¸Šå‚³å¤±æ•—</div>
                <div class="error-message">${data || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤'}</div>
                <div class="modal-buttons">
                  <button class="modal-btn modal-btn-primary" onclick="document.getElementById('uploadModal').classList.remove('show'); window.captureSystem.uploadScreenshot()">é‡è©¦</button>
                  <button class="modal-btn modal-btn-secondary" onclick="document.getElementById('uploadModal').classList.remove('show')">å–æ¶ˆ</button>
                </div>
              `;
              break;
          }
          
          // é¡¯ç¤ºå½ˆçª—
          modal.classList.add('show');
          
          // ç¶å®šé»æ“ŠèƒŒæ™¯é—œé–‰
          modal.onclick = (e) => {
            if (e.target === modal && state !== 'loading') {
              modal.classList.remove('show');
            }
          };
        }
      }

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        window.captureSystem = new HighDPICaptureSystem();
      });
    </script>
  </body>
</html>