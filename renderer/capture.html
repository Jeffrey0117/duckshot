<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dukshot - 截圖</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans TC", sans-serif;
        overflow: hidden;
        background: transparent;
        user-select: none;
      }

      /* 整體覆層 */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }

      /* 暗區域 - 使用四個獨立的 div */
      .dark-area {
        position: absolute;
        background: rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        cursor: crosshair !important; /* 確保暗區總是顯示十字游標 */
      }

      /* 選取區域容器 */
      .selection-box {
        position: absolute;
        border: 2px solid #0080ff;
        background: transparent;
        pointer-events: auto;
        z-index: 5;
        display: none;
      }

      .selection-box.active {
        display: block;
      }

      /* 選取區域內容區（用於拖曳） */
      .selection-content {
        position: absolute;
        width: 100%;
        height: 100%;
        background: transparent;
        cursor: move;
      }

      /* 調整大小控制點容器 */
      .resize-handles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      
      /* 單個控制點樣式 */
      .resize-handle {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid #0080ff;
        pointer-events: auto;
        z-index: 10;
      }

      /* 角控制點 */
      .resize-handle.top-left,
      .resize-handle.top-right,
      .resize-handle.bottom-left,
      .resize-handle.bottom-right {
        width: 12px;
        height: 12px;
      }

      .resize-handle.top-left {
        top: -6px;
        left: -6px;
        cursor: nw-resize;
      }

      .resize-handle.top-right {
        top: -6px;
        right: -6px;
        cursor: ne-resize;
      }

      .resize-handle.bottom-left {
        bottom: -6px;
        left: -6px;
        cursor: sw-resize;
      }

      .resize-handle.bottom-right {
        bottom: -6px;
        right: -6px;
        cursor: se-resize;
      }

      /* 邊控制點 */
      .resize-handle.top-center,
      .resize-handle.bottom-center {
        width: 12px;
        height: 12px;
        left: 50%;
        transform: translateX(-50%);
      }

      .resize-handle.top-center {
        top: -6px;
        cursor: n-resize;
      }

      .resize-handle.bottom-center {
        bottom: -6px;
        cursor: s-resize;
      }

      .resize-handle.middle-left,
      .resize-handle.middle-right {
        width: 12px;
        height: 12px;
        top: 50%;
        transform: translateY(-50%);
      }

      .resize-handle.middle-left {
        left: -6px;
        cursor: w-resize;
      }

      .resize-handle.middle-right {
        right: -6px;
        cursor: e-resize;
      }

      /* 選取資訊 */
      .selection-info {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-family: "Consolas", monospace;
        z-index: 1001;
        pointer-events: none;
      }

      /* 背景畫布 */
      #backgroundCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
      }

      /* 工具列 */
      .capture-toolbar {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 1002;
        display: none;
        gap: 6px;
        align-items: center;
        flex-direction: row;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .capture-btn {
        width: 48px;
        height: 44px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        transition: all 0.2s ease;
        padding: 4px;
        text-align: center;
      }

      .capture-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .capture-btn svg {
        transition: transform 0.2s ease;
        display: block;
      }

      .capture-btn .btn-text {
        font-size: 10px;
        line-height: 1;
        color: rgba(255,255,255,0.95);
        user-select: none;
        pointer-events: none;
      }

      .capture-btn:hover svg {
        transform: scale(1.1);
      }

      /* 幫助文字 */
      .help-text {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1003;
        text-align: center;
      }

      /* 尺寸顯示 */
      .dimension-display {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-family: "Consolas", monospace;
        z-index: 1005;
        pointer-events: none;
        white-space: nowrap;
      }

      /* DPI 診斷顯示 */
      .dpi-info {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: #0ff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-family: "Consolas", monospace;
        z-index: 1006;
        pointer-events: none;
        opacity: 0.8;
      }

      /* 上傳彈窗 */
      .upload-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .upload-modal.show {
        display: flex;
        opacity: 1;
      }

      .upload-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .upload-modal.show .upload-content {
        transform: scale(1);
      }

      .upload-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #333;
      }

      /* 載入動畫 */
      .upload-loading {
        text-align: center;
        padding: 20px 0;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0080ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* 成功狀態 */
      .upload-success {
        color: #28a745;
      }

      .upload-preview {
        margin: 16px 0;
        text-align: center;
      }

      .upload-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .upload-links {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
      }

      .link-row {
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .link-label {
        font-weight: 600;
        font-size: 13px;
        color: #666;
        min-width: 80px;
      }

      .link-value {
        flex: 1;
        font-size: 12px;
        background: white;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        word-break: break-all;
        cursor: pointer;
      }

      .link-value:hover {
        background: #f0f0f0;
      }

      .copy-btn-small {
        padding: 4px 8px;
        background: #0080ff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
      }

      .copy-btn-small:hover {
        background: #0066cc;
      }

      /* 錯誤狀態 */
      .upload-error {
        color: #dc3545;
        text-align: center;
        padding: 20px 0;
      }

      .error-message {
        margin: 16px 0;
        padding: 12px;
        background: #fee;
        border-radius: 8px;
        color: #c00;
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: #0080ff;
        color: white;
      }

      .modal-btn-primary:hover {
        background: #0066cc;
      }

      .modal-btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .modal-btn-secondary:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div class="help-text">拖曳選區｜Esc 取消｜右鍵重抓/取消｜Enter 儲存｜Ctrl+C 複製</div>

    <!-- 背景畫布 -->
    <canvas id="backgroundCanvas"></canvas>

    <!-- 覆層容器 -->
    <div class="overlay" id="overlay">
      <!-- 四個暗區 -->
      <div class="dark-area" data-area="top"></div>
      <div class="dark-area" data-area="bottom"></div>
      <div class="dark-area" data-area="left"></div>
      <div class="dark-area" data-area="right"></div>

      <!-- 選取區域 -->
      <div class="selection-box" id="selectionBox">
        <div class="selection-content"></div>
        <div class="resize-handles">
          <div class="resize-handle top-left"></div>
          <div class="resize-handle top-center"></div>
          <div class="resize-handle top-right"></div>
          <div class="resize-handle middle-left"></div>
          <div class="resize-handle middle-right"></div>
          <div class="resize-handle bottom-left"></div>
          <div class="resize-handle bottom-center"></div>
          <div class="resize-handle bottom-right"></div>
        </div>
      </div>
    </div>

    <!-- 尺寸顯示 -->
    <div class="dimension-display" id="dimensionDisplay" style="display: none;"></div>

    <!-- DPI 診斷資訊 -->
    <div class="dpi-info" id="dpiInfo"></div>

    <!-- 上傳彈窗 -->
    <div class="upload-modal" id="uploadModal">
      <div class="upload-content">
        <div id="uploadModalContent">
          <!-- 動態內容 -->
        </div>
      </div>
    </div>

    <!-- 工具列 -->
    <div class="capture-toolbar" id="captureToolbar">
      <button class="capture-btn" id="copyBtn" title="複製截圖 (Ctrl+C)">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/>
        </svg>
        <div class="btn-text">複製</div>
      </button>
      <button class="capture-btn" id="saveBtn" title="儲存截圖 (Enter)">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
        </svg>
        <div class="btn-text">儲存</div>
      </button>
      <button class="capture-btn" id="uploadBtn" title="上傳圖片">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" fill="currentColor"/>
        </svg>
        <div class="btn-text">上傳</div>
      </button>
      <button class="capture-btn" id="cancelBtn" title="取消 (Esc)">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
        </svg>
        <div class="btn-text">取消</div>
      </button>
    </div>

    <script>
      // 高 DPI 螢幕截圖系統
      class HighDPICaptureSystem {
        constructor() {
          this.canvas = document.getElementById('backgroundCanvas');
          this.ctx = this.canvas.getContext('2d');
          this.overlay = document.getElementById('overlay');
          this.selectionBox = document.getElementById('selectionBox');
          this.dimensionDisplay = document.getElementById('dimensionDisplay');
          this.toolbar = document.getElementById('captureToolbar');
          this.dpiInfo = document.getElementById('dpiInfo');
          this.uploadModal = document.getElementById('uploadModal');
          
          // DPI 相關
          this.dpr = window.devicePixelRatio || 1;
          
          // 選取狀態
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.selection = null;
          
          // 拖曳相關
          this.dragStartX = 0;
          this.dragStartY = 0;
          
          // 調整大小相關
          this.resizeHandle = null;
          this.resizeStartX = 0;
          this.resizeStartY = 0;
          this.resizeStartSelection = null;
          
          // 上傳 API 設定
          this.API_URL = "https://api.urusai.cc/v1/upload";
          this.TOKEN = "5b857ee4fcaff92c51cd2ddfd1578b95670a5ddca0cd9831b5791640b42ad4215b857ee4fcaff92c51cd2ddfd1578b95670a5ddca0cd9831b5791640b42ad421";
          
          // 初始化
          this.init();
        }

        async init() {
          console.log('=== DPI 診斷 ===');
          console.log('Device Pixel Ratio:', this.dpr);
          console.log('螢幕尺寸:', window.screen.width, 'x', window.screen.height);
          
          // 顯示 DPI 資訊
          this.showDPIInfo();
          
          // 設定高解析度畫布
          this.setupHighDPICanvas();
          
          // 設定事件監聽
          this.setupEventListeners();
          
          // 監聽螢幕數據
          this.listenForScreenData();
        }

        showDPIInfo() {
          if (this.dpiInfo) {
            this.dpiInfo.textContent = `DPR: ${this.dpr} | ${window.screen.width}×${window.screen.height}`;
            // 3秒後隱藏
            setTimeout(() => {
              this.dpiInfo.style.display = 'none';
            }, 3000);
          }
        }

        setupHighDPICanvas() {
          const screenWidth = window.screen.width;
          const screenHeight = window.screen.height;
          
          // 設定實際解析度（考慮 DPI）
          this.canvas.width = screenWidth * this.dpr;
          this.canvas.height = screenHeight * this.dpr;
          
          // 設定 CSS 顯示尺寸
          this.canvas.style.width = screenWidth + 'px';
          this.canvas.style.height = screenHeight + 'px';
          
          console.log('Canvas 實際尺寸:', this.canvas.width, 'x', this.canvas.height);
          console.log('Canvas CSS 尺寸:', this.canvas.style.width, 'x', this.canvas.style.height);
          console.log('Device Pixel Ratio:', this.dpr);
          
          // 設定 2D context 的縮放以匹配 DPI
          this.ctx.scale(this.dpr, this.dpr);
          
          // 關閉圖片平滑以保持最高畫質（避免模糊）
          this.ctx.imageSmoothingEnabled = false;
          this.ctx.mozImageSmoothingEnabled = false;
          this.ctx.webkitImageSmoothingEnabled = false;
          this.ctx.msImageSmoothingEnabled = false;
          
          // 重置縮放（因為我們會在繪製時處理）
          this.ctx.setTransform(1, 0, 0, 1, 0, 0);
        }

        listenForScreenData() {
          window.electronAPI.onScreenData((screenData) => {
            console.log('接收到螢幕數據');
            this.loadHighResScreenImage(screenData);
          });
        }

        loadHighResScreenImage(screenData) {
          const img = new Image();
          
          img.onload = () => {
            console.log('圖片載入完成');
            console.log('圖片原始尺寸:', img.naturalWidth, 'x', img.naturalHeight);
            
            // 清除 canvas
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            // 保存當前狀態
            this.ctx.save();
            
            // 重置變換矩陣，確保精確繪製
            this.ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            // 判斷圖片和 canvas 的比例
            const scaleX = this.canvas.width / img.naturalWidth;
            const scaleY = this.canvas.height / img.naturalHeight;
            
            console.log('縮放比例:', scaleX, 'x', scaleY);
            
            // 根據比例選擇最佳繪製方式
            if (Math.abs(scaleX - 1) < 0.001 && Math.abs(scaleY - 1) < 0.001) {
              console.log('1:1 原生繪製（無縮放）');
              // 關閉平滑處理
              this.ctx.imageSmoothingEnabled = false;
              this.ctx.mozImageSmoothingEnabled = false;
              this.ctx.webkitImageSmoothingEnabled = false;
              this.ctx.msImageSmoothingEnabled = false;
              
              // 直接 1:1 繪製
              this.ctx.drawImage(img, 0, 0);
            } else if (scaleX === scaleY && scaleX > 1) {
              console.log('等比放大繪製');
              // 放大時關閉平滑處理以保持銳利
              this.ctx.imageSmoothingEnabled = false;
              this.ctx.mozImageSmoothingEnabled = false;
              this.ctx.webkitImageSmoothingEnabled = false;
              this.ctx.msImageSmoothingEnabled = false;
              
              // 使用高品質縮放算法
              this.ctx.drawImage(
                img,
                0, 0, img.naturalWidth, img.naturalHeight,
                0, 0, this.canvas.width, this.canvas.height
              );
            } else {
              console.log('需要縮放繪製');
              // 對於需要縮小的情況，使用高品質平滑處理
              this.ctx.imageSmoothingEnabled = true;
              this.ctx.imageSmoothingQuality = 'high';
              
              // 繪製完整解析度圖片
              this.ctx.drawImage(
                img,
                0, 0, img.naturalWidth, img.naturalHeight,
                0, 0, this.canvas.width, this.canvas.height
              );
              
              // 繪製後立即關閉平滑，避免影響後續操作
              this.ctx.imageSmoothingEnabled = false;
            }
            
            // 恢復狀態
            this.ctx.restore();
            
            // 顯示初始暗覆層
            this.showInitialDarkOverlay();
          };
          
          img.onerror = (error) => {
            console.error('圖片載入失敗:', error);
          };
          
          img.src = screenData;
        }

        showInitialDarkOverlay() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.display = 'block';
          });
          
          // 設定初始全螢幕暗區
          this.updateDarkAreaPaths();
        }

        setupEventListeners() {
          // 暗區處理
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            // 確保暗區只有 crosshair 游標
            area.style.cursor = 'crosshair';
            
            area.addEventListener('mousedown', (e) => {
              if (e.target === area) {
                this.startNewSelection(e.clientX, e.clientY);
              }
            });
            
            // 防止暗區顯示調整大小的游標
            area.addEventListener('mousemove', (e) => {
              if (e.target === area) {
                area.style.cursor = 'crosshair';
              }
            });
          });

          // 選取區域內容拖曳
          const selectionContent = this.selectionBox.querySelector('.selection-content');
          selectionContent.style.cursor = 'move';  // 確保游標為 move
          
          selectionContent.addEventListener('mousedown', (e) => {
            if (e.target === selectionContent) {
              this.isDraggingSelection = true;
              this.dragStartX = e.clientX - this.selection.x;
              this.dragStartY = e.clientY - this.selection.y;
              e.stopPropagation();
            }
          });
          
          // 當滑鼠進入選取區域時確保顯示正確的游標
          selectionContent.addEventListener('mouseenter', () => {
            if (!this.isResizing && !this.isSelecting) {
              selectionContent.style.cursor = 'move';
            }
          });

          // 建立調整控制點
          const handles = [
            { class: 'top-left', cursor: 'nw-resize' },
            { class: 'top-center', cursor: 'n-resize' },
            { class: 'top-right', cursor: 'ne-resize' },
            { class: 'middle-left', cursor: 'w-resize' },
            { class: 'middle-right', cursor: 'e-resize' },
            { class: 'bottom-left', cursor: 'sw-resize' },
            { class: 'bottom-center', cursor: 's-resize' },
            { class: 'bottom-right', cursor: 'se-resize' }
          ];

          const resizeHandles = this.selectionBox.querySelector('.resize-handles');
          handles.forEach(handleInfo => {
            const handle = resizeHandles.querySelector(`.${handleInfo.class}`);
            if (handle) {
              // 設定游標
              handle.style.cursor = handleInfo.cursor;
              
              // 確保游標在懸停時顯示正確
              handle.addEventListener('mouseenter', () => {
                handle.style.cursor = handleInfo.cursor;
              });
              
              handle.addEventListener('mousedown', (e) => {
                this.isResizing = true;
                this.resizeHandle = handleInfo.class;
                this.resizeStartX = e.clientX;
                this.resizeStartY = e.clientY;
                this.resizeStartSelection = { ...this.selection };
                e.stopPropagation();
              });
            }
          });

          // 文檔級別的滑鼠事件
          document.addEventListener('mousemove', this.onMouseMove.bind(this));
          document.addEventListener('mouseup', this.onMouseUp.bind(this));
          
          // 鍵盤事件
          document.addEventListener('keydown', this.onKeyDown.bind(this));
          
          // 工具列按鈕
          document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());
          document.getElementById('saveBtn').addEventListener('click', () => this.saveScreenshot());
          document.getElementById('uploadBtn').addEventListener('click', () => this.uploadScreenshot());
          document.getElementById('cancelBtn').addEventListener('click', () => window.close());
        }

        startNewSelection(x, y) {
          this.isSelecting = true;
          this.dragStartX = x;
          this.dragStartY = y;
          this.selection = { x, y, width: 0, height: 0 };
          
          // 隱藏工具列
          this.toolbar.style.display = 'none';
          document.querySelector('.help-text').style.display = 'none';
        }

        updateDarkAreaPaths() {
          const darkAreas = this.overlay.querySelectorAll('.dark-area');
          darkAreas.forEach(area => {
            area.style.clipPath = '';
            // 確保暗區保持 crosshair 游標
            area.style.cursor = 'crosshair';
          });
          
          if (!this.selection) {
            // 全螢幕暗化
            darkAreas.forEach(area => {
              const areaType = area.dataset.area;
              switch (areaType) {
                case 'top':
                  area.style.cssText = 'top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair;';
                  break;
                case 'bottom':
                case 'left':
                case 'right':
                  area.style.cssText = 'display: none;';
                  break;
              }
            });
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          // 根據位置設定不同暗區
          darkAreas.forEach(area => {
            const areaType = area.dataset.area;
            area.style.display = 'block';
            area.style.cursor = 'crosshair'; // 強制設定游標
            
            switch (areaType) {
              case 'top':
                area.style.cssText = `top: 0; left: 0; width: 100%; height: ${y}px; cursor: crosshair;`;
                break;
              case 'bottom':
                area.style.cssText = `top: ${y + height}px; left: 0; width: 100%; bottom: 0; cursor: crosshair;`;
                break;
              case 'left':
                area.style.cssText = `top: ${y}px; left: 0; width: ${x}px; height: ${height}px; cursor: crosshair;`;
                break;
              case 'right':
                area.style.cssText = `top: ${y}px; left: ${x + width}px; right: 0; height: ${height}px; cursor: crosshair;`;
                break;
            }
          });
        }

        updateSelectionBox() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          this.selectionBox.style.left = x + 'px';
          this.selectionBox.style.top = y + 'px';
          this.selectionBox.style.width = width + 'px';
          this.selectionBox.style.height = height + 'px';
          this.selectionBox.classList.add('active');
          
          this.updateDarkAreaPaths();
        }

        updateDimensionDisplay() {
          if (!this.selection) {
            this.dimensionDisplay.style.display = 'none';
            return;
          }
          
          const { x, y, width, height } = this.selection;
          
          // 顯示實際像素尺寸（考慮 DPI）
          const actualWidth = Math.round(width * this.dpr);
          const actualHeight = Math.round(height * this.dpr);
          
          this.dimensionDisplay.textContent = `${actualWidth} × ${actualHeight} px`;
          this.dimensionDisplay.style.display = 'block';
          
          // 位置在選區右上角
          let displayX = x + width + 10;
          let displayY = y;
          
          // 邊界檢查
          if (displayX + 150 > window.innerWidth) {
            displayX = x - 160;
          }
          if (displayY < 10) {
            displayY = 10;
          }
          
          this.dimensionDisplay.style.left = displayX + 'px';
          this.dimensionDisplay.style.top = displayY + 'px';
        }

        onMouseMove(e) {
          if (this.isDraggingSelection && this.selection) {
            // 拖曳選取區域時保持 move 游標
            document.body.style.cursor = 'move';
            
            // 移動時隱藏工具列避免擋住視線
            this.toolbar.style.display = 'none';
            
            this.selection.x = Math.max(0, Math.min(window.innerWidth - this.selection.width, e.clientX - this.dragStartX));
            this.selection.y = Math.max(0, Math.min(window.innerHeight - this.selection.height, e.clientY - this.dragStartY));
            this.updateSelectionBox();
            this.updateDimensionDisplay();
            this.updateToolbarPosition(); // 更新工具列位置
          } else if (this.isResizing && this.selection && this.resizeStartSelection) {
            const dx = e.clientX - this.resizeStartX;
            const dy = e.clientY - this.resizeStartY;
            
            // 調整大小時隱藏工具列
            this.toolbar.style.display = 'none';
            
            // 根據控制點調整選區
            this.adjustSelection(this.resizeHandle, dx, dy);
            this.updateSelectionBox();
            this.updateDimensionDisplay();
            this.updateToolbarPosition(); // 更新工具列位置
          } else if (this.isSelecting) {
            const width = Math.abs(e.clientX - this.dragStartX);
            const height = Math.abs(e.clientY - this.dragStartY);
            const x = Math.min(e.clientX, this.dragStartX);
            const y = Math.min(e.clientY, this.dragStartY);
            
            this.selection = { x, y, width, height };
            this.updateSelectionBox();
            this.updateDimensionDisplay();
          }
        }

        adjustSelection(handle, dx, dy) {
          const original = this.resizeStartSelection;
          let newX = original.x;
          let newY = original.y;
          let newWidth = original.width;
          let newHeight = original.height;
          
          switch (handle) {
            case 'top-left':
              newX = original.x + dx;
              newY = original.y + dy;
              newWidth = original.width - dx;
              newHeight = original.height - dy;
              break;
            case 'top-center':
              newY = original.y + dy;
              newHeight = original.height - dy;
              break;
            case 'top-right':
              newY = original.y + dy;
              newWidth = original.width + dx;
              newHeight = original.height - dy;
              break;
            case 'middle-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              break;
            case 'middle-right':
              newWidth = original.width + dx;
              break;
            case 'bottom-left':
              newX = original.x + dx;
              newWidth = original.width - dx;
              newHeight = original.height + dy;
              break;
            case 'bottom-center':
              newHeight = original.height + dy;
              break;
            case 'bottom-right':
              newWidth = original.width + dx;
              newHeight = original.height + dy;
              break;
          }
          
          // 確保最小尺寸
          if (newWidth < 10) newWidth = 10;
          if (newHeight < 10) newHeight = 10;
          
          // 邊界檢查
          if (newX < 0) {
            newWidth += newX;
            newX = 0;
          }
          if (newY < 0) {
            newHeight += newY;
            newY = 0;
          }
          if (newX + newWidth > window.innerWidth) {
            newWidth = window.innerWidth - newX;
          }
          if (newY + newHeight > window.innerHeight) {
            newHeight = window.innerHeight - newY;
          }
          
          this.selection = {
            x: Math.round(newX),
            y: Math.round(newY),
            width: Math.round(newWidth),
            height: Math.round(newHeight)
          };
        }

        onMouseUp(e) {
          if (this.isSelecting && this.selection) {
            // 確保選取區域有最小大小
            if (this.selection.width < 10 || this.selection.height < 10) {
              this.clearSelection();
            } else {
              this.showToolbar();
            }
          }
          
          // 拖曳或調整大小結束後，重新顯示工具列
          if ((this.isDraggingSelection || this.isResizing) && this.selection) {
            this.showToolbar();
          }
          
          // 重置游標
          if (this.isDraggingSelection || this.isResizing) {
            document.body.style.cursor = '';
          }
          
          this.isSelecting = false;
          this.isDraggingSelection = false;
          this.isResizing = false;
          this.resizeHandle = null;
          this.resizeStartSelection = null;
        }

        onKeyDown(e) {
          if (e.key === 'Escape') {
            window.close();
          } else if (e.key === 'Enter' && this.selection) {
            this.saveScreenshot();
          } else if ((e.ctrlKey || e.metaKey) && e.key === 'c' && this.selection) {
            e.preventDefault();
            this.copyToClipboard();
          }
        }

        clearSelection() {
          this.selection = null;
          this.selectionBox.classList.remove('active');
          this.dimensionDisplay.style.display = 'none';
          this.toolbar.style.display = 'none';
          this.showInitialDarkOverlay();
        }

        showToolbar() {
          if (!this.selection) return;
          
          const { x, y, width, height } = this.selection;
          
          // 計算工具列位置
          let left = x + width - 210; // 調整為 4 個小按鈕的寬度
          let top = y + height + 8;
          
          // 邊界檢查
          if (left < 10) left = 10;
          if (left + 210 > window.innerWidth) left = window.innerWidth - 220;
          if (top + 60 > window.innerHeight) top = y - 70;
          
          this.toolbar.style.left = left + 'px';
          this.toolbar.style.top = top + 'px';
          this.toolbar.style.display = 'flex';
        }

        updateToolbarPosition() {
          if (!this.selection || this.toolbar.style.display === 'none') return;
          
          const { x, y, width, height } = this.selection;
          
          // 計算工具列位置
          let left = x + width - 210; // 調整為 4 個小按鈕的寬度
          let top = y + height + 8;
          
          // 邊界檢查
          if (left < 10) left = 10;
          if (left + 210 > window.innerWidth) left = window.innerWidth - 220;
          if (top + 60 > window.innerHeight) top = y - 70;
          
          this.toolbar.style.left = left + 'px';
          this.toolbar.style.top = top + 'px';
        }

        async copyToClipboard() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 設定高解析度尺寸
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            // 關閉圖片平滑以保持最高品質（避免模糊）
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            
            // 從高解析度 canvas 擷取
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            tempCanvas.toBlob(async (blob) => {
              await navigator.clipboard.write([
                new ClipboardItem({ [blob.type]: blob })
              ]);
              window.close();
            });
          } catch (error) {
            console.error('複製到剪貼簿失敗:', error);
          }
        }

        async saveScreenshot() {
          if (!this.selection) return;
          
          try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 設定高解析度尺寸
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            console.log('儲存截圖 - Canvas 尺寸:', tempCanvas.width, 'x', tempCanvas.height);
            
            // 關閉圖片平滑以保持最高銳利度
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            
            // 從高解析度 canvas 擷取正確的區域
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            // 轉換為高品質 PNG（PNG 不需要品質參數）
            const imageData = tempCanvas.toDataURL('image/png');
            const result = await window.electronAPI.saveScreenshot(imageData, 'png');
            
            if (result.success) {
              console.log('截圖儲存成功');
              window.close();
            } else {
              console.error('截圖儲存失敗:', result.error);
            }
          } catch (error) {
            console.error('儲存截圖失敗:', error);
          }
        }

        async uploadScreenshot() {
          if (!this.selection) return;
          
          try {
            // 顯示載入狀態
            this.showUploadModal('loading');
            
            // 創建臨時 canvas 獲取選取區域
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = this.selection.width * this.dpr;
            tempCanvas.height = this.selection.height * this.dpr;
            
            // 關閉圖片平滑以保持最高品質
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.mozImageSmoothingEnabled = false;
            tempCtx.webkitImageSmoothingEnabled = false;
            tempCtx.msImageSmoothingEnabled = false;
            
            tempCtx.drawImage(
              this.canvas,
              this.selection.x * this.dpr,
              this.selection.y * this.dpr,
              this.selection.width * this.dpr,
              this.selection.height * this.dpr,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            
            // 轉換為 Blob（PNG 格式使用最高品質）
            const blob = await new Promise(resolve => {
              tempCanvas.toBlob(resolve, 'image/png');
            });
            
            // 創建 FormData
            const formData = new FormData();
            formData.append('file', blob, 'screenshot.png');
            formData.append('token', this.TOKEN);
            formData.append('r18', '0');
            
            // 發送請求
            const response = await fetch(this.API_URL, {
              method: 'POST',
              body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
              this.showUploadModal('success', data.data);
              // 自動複製直連到剪貼簿
              if (data.data.url_direct) {
                navigator.clipboard.writeText(data.data.url_direct);
              }
            } else {
              this.showUploadModal('error', data.message || '上傳失敗');
            }
          } catch (error) {
            console.error('上傳截圖失敗:', error);
            this.showUploadModal('error', error.message || '網路錯誤');
          }
        }

        showUploadModal(state, data = null) {
          const modal = this.uploadModal;
          const content = document.getElementById('uploadModalContent');
          
          switch (state) {
            case 'loading':
              content.innerHTML = `
                <div class="upload-title">正在上傳...</div>
                <div class="upload-loading">
                  <div class="spinner"></div>
                  <div>請稍候，正在上傳截圖到伺服器</div>
                </div>
              `;
              break;
              
            case 'success':
              content.innerHTML = `
                <div class="upload-title upload-success">✓ 上傳成功！</div>
                <div style="color: #28a745; text-align: center; margin: 20px 0; font-size: 16px;">
                  圖片已成功上傳<br>
                  <span style="font-size: 14px; color: #666; margin-top: 8px; display: block;">
                    連結已複製到剪貼簿
                  </span>
                </div>
                <div class="modal-buttons">
                  <button class="modal-btn modal-btn-primary" onclick="window.close()">完成</button>
                </div>
              `;
              break;
              
            case 'error':
              content.innerHTML = `
                <div class="upload-title upload-error">✗ 上傳失敗</div>
                <div class="error-message">${data || '發生未知錯誤'}</div>
                <div class="modal-buttons">
                  <button class="modal-btn modal-btn-primary" onclick="document.getElementById('uploadModal').classList.remove('show'); window.captureSystem.uploadScreenshot()">重試</button>
                  <button class="modal-btn modal-btn-secondary" onclick="document.getElementById('uploadModal').classList.remove('show')">取消</button>
                </div>
              `;
              break;
          }
          
          // 顯示彈窗
          modal.classList.add('show');
          
          // 綁定點擊背景關閉
          modal.onclick = (e) => {
            if (e.target === modal && state !== 'loading') {
              modal.classList.remove('show');
            }
          };
        }
      }

      // 初始化
      document.addEventListener('DOMContentLoaded', () => {
        window.captureSystem = new HighDPICaptureSystem();
      });
    </script>
  </body>
</html>