# 截圖功能卡死問題修復計畫

## 問題概述

使用者回報嚴重問題：
1. 無法開始選取（滑鼠左鍵按下無反應）
2. ESC 鍵無法退出截圖模式
3. 整個截圖界面卡死，需要強制關閉

## 1. 問題診斷（Root Cause Analysis）

經過程式碼分析，發現以下關鍵問題：

### 1.1 重複方法定義導致事件綁定失敗
- **主要原因**：`capture.html` 中存在重複的 `onMouseMove` 和 `onMouseUp` 方法定義
  - 第一組：行 475-491 和 500-529
  - 第二組：行 614-624 和 626-649
- **影響**：JavaScript 引擎只保留最後一個定義，導致事件處理邏輯不完整

### 1.2 事件監聽器綁定時機問題
- **問題**：`setupEventListeners()` 在 DOM 完全載入前調用（行 304）
- **影響**：Canvas 元素可能未完全準備好，導致事件綁定失敗

### 1.3 程式碼結構混亂
- **問題**：方法定義散布在類別內部不同位置，缺乏邏輯組織
- **影響**：代碼可讀性差，容易產生重複定義

### 1.4 錯誤處理不足
- **問題**：缺少事件綁定失敗的檢查和回退機制
- **影響**：無法及早發現並處理問題

## 2. 檢查清單（Checklist）

### 2.1 基本功能檢查
- [ ] Console 是否有 JavaScript 錯誤訊息
- [ ] Canvas 元素是否正確載入和初始化
- [ ] 事件監聽器是否正確綁定到 Canvas
- [ ] 滑鼠事件處理方法是否正確定義

### 2.2 程式碼完整性檢查
- [ ] 檢查是否有重複的方法定義
- [ ] 驗證 `this` 綁定是否正確
- [ ] 確認所有事件處理器都已正確實作

### 2.3 初始化流程檢查
- [ ] DOM 載入順序是否正確
- [ ] CaptureScreen 類別實例化時機
- [ ] 螢幕資料傳遞是否成功

## 3. 修復策略（Fix Strategy）

### Phase 1: 緊急修復（確保基本功能）
1. **清理重複方法定義**
   - 移除重複的 `onMouseMove` 和 `onMouseUp` 方法
   - 保留功能完整的版本

2. **修復事件綁定**
   - 確保事件監聽器正確綁定
   - 加入錯誤檢查機制

### Phase 2: 程式碼重構（提升穩定性）
1. **重組程式碼結構**
   - 將所有事件處理方法集中定義
   - 改善程式碼可讀性

2. **加強錯誤處理**
   - 加入 try-catch 包裝
   - 實作回退機制

### Phase 3: 新功能整合驗證
1. **測試所有功能模組**
   - 拖曳功能
   - 延伸線功能
   - 尺寸標示功能

## 4. 實施步驟（Implementation Steps）

### 步驟 1：問題確認與備份
1. 備份現有的 `capture.html` 檔案
2. 確認問題重現步驟
3. 記錄 Console 錯誤訊息

### 步驟 2：修復重複定義問題
1. 移除第一組重複的方法定義（行 475-491, 500-529）
2. 保留第二組完整的方法實作（行 614-624, 626-649）
3. 確認所有方法只定義一次

### 步驟 3：優化事件綁定流程
1. 在 `setupEventListeners` 中加入元素存在性檢查
2. 加入事件綁定成功確認
3. 實作錯誤處理和重試機制

### 步驟 4：重構程式碼結構
1. 重新整理 CaptureScreen 類別方法順序
2. 將相關方法群組化
3. 加入適當的註釋說明

### 步驟 5：全面測試
1. 測試基本選取功能
2. 測試所有快捷鍵（ESC、Enter、Ctrl+C）
3. 測試新增的拖曳和尺寸標示功能

## 5. 測試計畫（Testing Plan）

### 5.1 單元測試
- **滑鼠事件**：測試 mousedown, mousemove, mouseup
- **鍵盤事件**：測試 ESC, Enter, Ctrl+C
- **介面元素**：測試工具列顯示/隱藏

### 5.2 整合測試
- **完整截圖流程**：從開啟到儲存
- **錯誤情境**：模擬各種異常狀況
- **效能測試**：確認不會影響整體效能

### 5.3 邊界測試
- **極端尺寸**：測試過小或過大的選取區域
- **快速操作**：測試連續快速的滑鼠操作
- **多次開關**：測試反覆開啟關閉截圖功能

## 6. 回滾計畫（Rollback Plan）

### 6.1 版本控制策略
- 在修復前建立分支或標籤
- 保留完整的修改記錄
- 準備快速回滾腳本

### 6.2 識別最後可用版本
- 檢查 Git 提交歷史
- 找出功能正常的最後一個版本
- 準備緊急回滾方案

### 6.3 逐步回滾策略
1. **優先回滾**：若新修復完全失敗，立即回滾到穩定版本
2. **部分回滾**：若只有部分功能有問題，僅回滾相關變更
3. **重新實施**：分析回滾原因，重新制定修復方案

## 7. 成功指標

### 7.1 功能指標
- ✅ 滑鼠左鍵點擊能正常開始選取
- ✅ ESC 鍵能正常退出截圖模式
- ✅ 所有工具列按鈕功能正常
- ✅ 新增功能（拖曳、延伸線、尺寸標示）正常運作

### 7.2 穩定性指標
- ✅ 連續使用 30 分鐘無卡死現象
- ✅ Console 無 JavaScript 錯誤
- ✅ 記憶體使用量穩定

### 7.3 使用者體驗指標
- ✅ 響應時間 < 100ms
- ✅ 介面操作流暢
- ✅ 視覺反饋清晰

## 8. 預防措施

### 8.1 程式碼品質改進
1. 實施程式碼 linting 規則
2. 加入自動化測試
3. 建立程式碼審查流程

### 8.2 監控機制
1. 加入錯誤日誌記錄
2. 實作效能監控
3. 建立使用者反饋收集機制

---

**注意**：此計畫將分階段實施，確保每個階段都經過充分測試才進入下一階段。優先修復基本功能，再逐步改進和優化。